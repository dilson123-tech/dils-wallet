name: CI â€” dils-wallet

on:
  push:
    branches: [ main, chore/**, feat/**, fix/** ]
  pull_request:
    branches: [ main ]

jobs:
  backend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Sanity compile
        run: python -m compileall .

  client-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: aurea-gold-client
    steps:
      - uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: aurea-gold-client/package-lock.json

      - name: Install & Build
        run: |
          npm ci
          npm run build

  smoke-prod:
    runs-on: ubuntu-latest
    needs: [backend-build, client-build]
    if: ${{ github.ref == 'refs/heads/main' && secrets.SMOKE_BASE_URL != '' && secrets.HEALTH_TOKEN != '' }}
    env:
      SMOKE_BASE_URL: ${{ secrets.SMOKE_BASE_URL }}   # ex: https://dils-wallet2-production.up.railway.app
      HEALTH_TOKEN:   ${{ secrets.HEALTH_TOKEN }}     # header de health
      BEARER_TOKEN:   ${{ secrets.BEARER_TOKEN }}     # opcional p/ endpoints protegidos
    steps:
      - name: Healthz
        run: |
          set -e
          echo ">> /healthz"
          curl -fsS --retry 10 --retry-all-errors --retry-delay 1 -H "X-Health-Token: ${HEALTH_TOKEN}" "${SMOKE_BASE_URL}/healthz" | jq .

      - name: Auth sanity (opcional)
        if: ${{ env.BEARER_TOKEN != '' }}
        run: |
          echo ">> /api/v1/transactions/balance"
          curl -fsS -H "Authorization: Bearer ${BEARER_TOKEN}" "${SMOKE_BASE_URL}/api/v1/transactions/balance" | jq .
