name: Smoke PR (Read-only)
on:
  pull_request:
  workflow_dispatch:
    branches: [ main ]

jobs:
  smoke_pr:
    runs-on: ubuntu-latest
    env:
      SMOKE_BASE: ${{ secrets.SMOKE_BASE }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Gate Smoke PR (secrets present?)
        id: gate
        shell: bash
        env:
          GH_EVENT: ${{ github.event_name }}
        run: |
          if [ "${GH_EVENT:-}" = "pull_request" ]; then
            echo "run=false" >> "$GITHUB_OUTPUT"
            echo "SMOKE PR: SKIP on pull_request (read-only safety)"
          elif [ -n "${SMOKE_BASE:-}" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
            echo "SMOKE PR: SKIP (missing SMOKE_BASE secret)"
          fi
          if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
            echo "slack=true" >> "$GITHUB_OUTPUT"
          else
            echo "slack=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Checkout
        if: ${{ steps.gate.outputs.run == 'true' }}
        uses: actions/checkout@v4

      - name: Deps (jq, curl)
        if: ${{ steps.gate.outputs.run == 'true' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Smoke read-only
        if: ${{ steps.gate.outputs.run == 'true' }}
        env:
          SMOKE_BASE: ${{ env.SMOKE_BASE }} # produção ok porque é somente leitura
          EMAIL: "smoke@dilswallet.com"
          PASS: "123456"
        run: |
          chmod +x scripts/smoke_readonly.sh
          ./scripts/smoke_readonly.sh

      - name: Notificar Slack se falhar
        if: ${{ failure() && steps.gate.outputs.run == 'true' && steps.gate.outputs.slack == 'true' }}
        env:
          WEBHOOK: ${{ env.SLACK_WEBHOOK_URL }}
        run: |
          TS="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          MSG=$(printf '{"text":"❌ Smoke PR falhou @ %s\nrepo: %s\nrun: %s\njob: %s"}' \
              "$TS" "${{ github.repository }}" "${{ github.run_id }}" "smoke_pr")
          curl -s -L -X POST -H 'Content-type: application/json' --data "$MSG" "$WEBHOOK"
