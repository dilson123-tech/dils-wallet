name: Notify on Failure (Telegram)
on:
  workflow_run:
    workflows:
      - Smoke Prod
      - Smoke PR (Read-only)
      - Slack Webhook Test
    types: [completed]

jobs:
  notify:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram alert
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO: ${{ github.event.workflow_run.repository.full_name }}
          NAME: ${{ github.event.workflow_run.name }}
          STATUS: ${{ github.event.workflow_run.conclusion }}
          HTML_URL: ${{ github.event.workflow_run.html_url }}
        run: |
          set -euo pipefail
          MSG="‚ùå $NAME falhou em $REPO
status=$STATUS
run=$HTML_URL"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
               -d chat_id="$TELEGRAM_CHAT_ID" \
               -d text="$MSG"
