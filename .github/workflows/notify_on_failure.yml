name: Notify on Failure (Telegram)
on:
  workflow_run:
    workflows:
      - Smoke Prod
      - Smoke PR (Read-only)
      - Slack Webhook Test
      - Fail Fast
    types: [completed]

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Context debug
        run: |
          echo "TRIGGERED BY: ${{ github.event.workflow_run.name }}"
          echo "STATUS:       ${{ github.event.workflow_run.status }}"
          echo "CONCLUSION:   ${{ github.event.workflow_run.conclusion }}"
          echo "HTML_URL:     ${{ github.event.workflow_run.html_url }}"
          echo "REPO:         ${{ github.event.workflow_run.repository.full_name }}"

      # Gate: só continua se FALHOU (ou foi cancelado/timed_out)
      - name: Gate (only when not success)
        run: |
          c='${{ github.event.workflow_run.conclusion }}'
          if [ "$c" = "success" ]; then
            echo "Upstream SUCCESS → nada a notificar."; exit 0
          fi

      - name: Send Telegram alert
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO:       ${{ github.event.workflow_run.repository.full_name }}
          NAME:       ${{ github.event.workflow_run.name }}
          STATUS:     ${{ github.event.workflow_run.conclusion }}
          HTML_URL:   ${{ github.event.workflow_run.html_url }}
        run: |
          set -euo pipefail
          # valida vars (evita 404 do Telegram)
          : "${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN vazio}"
          : "${TELEGRAM_CHAT_ID:?TELEGRAM_CHAT_ID vazio}"

          MSG="❌ $NAME falhou em $REPO
status=$STATUS
run=$HTML_URL"

          echo "Enviando para Telegram chat_id=$TELEGRAM_CHAT_ID..."
          HTTP=$(curl -s -o /tmp/tg.txt -w '%{http_code}' \
                 -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                 -d chat_id="$TELEGRAM_CHAT_ID" \
                 --data-urlencode text="$MSG" )
          echo "HTTP=$HTTP"
          echo "BODY=$(cat /tmp/tg.txt)"
          [ "$HTTP" = "200" ] || exit 1
